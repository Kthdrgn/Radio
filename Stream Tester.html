<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Radio Stream Tester</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 { color: #333; }
        input[type="text"] {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
        }
        button:hover { background: #5568d3; }
        .test-result {
            margin: 20px 0;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        .working-streams {
            margin-top: 30px;
            padding: 20px;
            background: #e7f3ff;
            border-radius: 5px;
        }
        .stream-list {
            list-style: none;
            padding: 0;
        }
        .stream-list li {
            margin: 10px 0;
            padding: 10px;
            background: white;
            border-radius: 5px;
            cursor: pointer;
        }
        .stream-list li:hover {
            background: #f0f0f0;
        }
        #audio-test {
            width: 100%;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Radio Stream Tester</h1>
        <p>This tool will help diagnose why streams aren't loading.</p>

        <input type="text" id="test-url" placeholder="Enter stream URL to test" 
               value="https://stream.radioparadise.com/aac-320">
        
        <button onclick="testStream()">Test Stream</button>
        <button onclick="testWithAudio()">Test with Basic Audio</button>
        <button onclick="testWithMetadata()">Test with Metadata Player</button>

        <div id="results"></div>

        <audio id="audio-test" controls style="display:none;"></audio>

        <div class="working-streams">
            <h2>‚úÖ Known Working Streams (Click to Test)</h2>
            <ul class="stream-list">
                <li onclick="loadStream('https://stream.radioparadise.com/aac-320')">
                    üéµ Radio Paradise - AAC 320k
                </li>
                <li onclick="loadStream('https://icecast.omroep.nl/radio1-bb-mp3')">
                    üìª NPO Radio 1 (Netherlands) - MP3
                </li>
                <li onclick="loadStream('https://somafm.com/groovesalad256.pls')">
                    üé∂ SomaFM Groove Salad - MP3
                </li>
                <li onclick="loadStream('https://stream.srg-ssr.ch/m/rsj/mp3_128')">
                    üé∫ Swiss Jazz - MP3
                </li>
            </ul>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/icecast-metadata-player@2.0.8/dist/icecast-metadata-player.min.js"></script>
    <script>
        const resultsDiv = document.getElementById('results');
        const audioElement = document.getElementById('audio-test');
        const testUrlInput = document.getElementById('test-url');

        function loadStream(url) {
            testUrlInput.value = url;
            testWithMetadata();
        }

        function addResult(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `test-result ${type}`;
            div.innerHTML = message;
            resultsDiv.appendChild(div);
        }

        function clearResults() {
            resultsDiv.innerHTML = '';
        }

        async function testStream() {
            clearResults();
            const url = testUrlInput.value.trim();
            
            if (!url) {
                addResult('‚ùå Please enter a stream URL', 'error');
                return;
            }

            addResult(`üîç Testing: ${url}`, 'info');

            // Test 1: Basic fetch
            try {
                addResult('Test 1: Attempting basic fetch...', 'info');
                const response = await fetch(url, { 
                    method: 'HEAD',
                    mode: 'cors'
                });
                addResult(`‚úÖ Basic fetch successful! Status: ${response.status}`, 'success');
                addResult(`Headers: ${JSON.stringify([...response.headers])}`, 'info');
            } catch (error) {
                addResult(`‚ùå Basic fetch failed: ${error.message}`, 'error');
                
                if (error.message.includes('CORS')) {
                    addResult(`
                        <strong>CORS Issue Detected!</strong><br>
                        The stream server is blocking cross-origin requests.<br>
                        Solutions:<br>
                        1. Use a stream with CORS enabled (try the working streams below)<br>
                        2. Configure CORS headers on the Icecast server<br>
                        3. Use a CORS proxy (not recommended for production)
                    `, 'error');
                }
            }

            // Test 2: Check if it's HTTPS
            if (url.startsWith('http://')) {
                addResult(`‚ö†Ô∏è Warning: Using HTTP stream. If this page is HTTPS, it may be blocked by mixed content policy.`, 'error');
            }
        }

        function testWithAudio() {
            clearResults();
            const url = testUrlInput.value.trim();
            
            if (!url) {
                addResult('‚ùå Please enter a stream URL', 'error');
                return;
            }

            addResult(`üéµ Testing with HTML5 Audio Element...`, 'info');
            audioElement.style.display = 'block';
            audioElement.src = url;
            
            audioElement.onloadeddata = () => {
                addResult('‚úÖ Audio element loaded successfully!', 'success');
                audioElement.play().then(() => {
                    addResult('‚úÖ Playback started! You should hear audio.', 'success');
                }).catch(err => {
                    addResult(`‚ùå Playback error: ${err.message}`, 'error');
                });
            };

            audioElement.onerror = (e) => {
                const error = audioElement.error;
                let errorMsg = 'Unknown error';
                
                if (error) {
                    switch(error.code) {
                        case error.MEDIA_ERR_ABORTED:
                            errorMsg = 'Playback aborted';
                            break;
                        case error.MEDIA_ERR_NETWORK:
                            errorMsg = 'Network error - check CORS';
                            break;
                        case error.MEDIA_ERR_DECODE:
                            errorMsg = 'Decoding error - unsupported format';
                            break;
                        case error.MEDIA_ERR_SRC_NOT_SUPPORTED:
                            errorMsg = 'Source not supported - check URL and CORS';
                            break;
                    }
                }
                
                addResult(`‚ùå Audio error: ${errorMsg}`, 'error');
            };
        }

        function testWithMetadata() {
            clearResults();
            const url = testUrlInput.value.trim();
            
            if (!url) {
                addResult('‚ùå Please enter a stream URL', 'error');
                return;
            }

            addResult(`üéµ Testing with Icecast Metadata Player...`, 'info');
            audioElement.style.display = 'none';

            try {
                const player = new IcecastMetadataPlayer(url, {
                    onMetadata: (metadata) => {
                        addResult(`‚úÖ Metadata received: ${JSON.stringify(metadata, null, 2)}`, 'success');
                    },
                    onStreamStart: () => {
                        addResult('‚úÖ Stream started successfully!', 'success');
                    },
                    onError: (error) => {
                        addResult(`‚ùå Player error: ${error.message}`, 'error');
                        
                        if (error.message.includes('CORS')) {
                            addResult(`
                                <strong>CORS Issue!</strong><br>
                                The stream needs these headers:<br>
                                <code>Access-Control-Allow-Origin: *</code><br>
                                <code>Access-Control-Allow-Headers: Icy-Metadata</code>
                            `, 'error');
                        }
                    },
                    metadataTypes: ["icy", "ogg"]
                });

                addResult('Player created, attempting to play...', 'info');
                
                player.play().then(() => {
                    addResult('‚úÖ Play command executed', 'success');
                }).catch(err => {
                    addResult(`‚ùå Play failed: ${err.message}`, 'error');
                });

            } catch (error) {
                addResult(`‚ùå Failed to create player: ${error.message}`, 'error');
            }
        }

        // Show console logs
        window.addEventListener('error', (e) => {
            addResult(`Console error: ${e.message}`, 'error');
        });

        // Initial message
        addResult('üëã Ready to test! Try the working streams below or enter your own URL.', 'info');
    </script>
</body>
</html>